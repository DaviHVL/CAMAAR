<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>template_form_handler.js - RDoc Documentation</title>


  <meta name="keywords" content="ruby,documentation,template_form_handler.js">
  <meta name="description" content="template_form_handler.js: document. load&#39;, () =&gt; { const formContainer = document.">




<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
  var index_rel_prefix = "../../../";
</script>

<script src="../../../js/navigation.js" defer></script>
<script src="../../../js/search.js" defer></script>
<script src="../../../js/search_index.js" defer></script>
<script src="../../../js/searcher.js" defer></script>
<script src="../../../js/darkfish.js" defer></script>

<link href="../../../css/fonts.css" rel="stylesheet">
<link href="../../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="file">
<div id="navigation-toggle" role="button" tabindex="0" aria-label="Toggle sidebar" aria-expanded="true" aria-controls="navigation">
  <span aria-hidden="true">&#9776;</span>
</div>


<nav id="navigation" role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search (/) for a class, method, ..." spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  




<div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">



    <li><details open><summary>app</summary>
    <ul class="link-list">

      <li><a href="../../../app/assets/builds/tailwind_css.html">tailwind.css</a></li>

      <li><a href="../../../app/assets/stylesheets/application_css.html">application.css</a></li>

      <li><a href="../../../app/assets/tailwind/application_css.html">application.css</a></li>

      <li><a href="../../../app/javascript/application_js.html">application.js</a></li>

      <li><a href="../../../app/javascript/controllers/application_js.html">application.js</a></li>

      <li><a href="../../../app/javascript/controllers/dropdown_controller_js.html">dropdown_controller.js</a></li>

      <li><a href="../../../app/javascript/controllers/hello_controller_js.html">hello_controller.js</a></li>

      <li><a href="../../../app/javascript/controllers/index_js.html">index.js</a></li>

      <li><a href="../../../app/javascript/controllers/sidebar_controller_js.html">sidebar_controller.js</a></li>

      <li><a href="../../../app/javascript/controllers/template_form_handler_js.html">template_form_handler.js</a></li>

      <li><a href="../../../app/views/pwa/service-worker_js.html">service-worker.js</a></li>

    </ul></details></li>

  </ul>
</div>



  <footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a></p>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.15.1.</p>
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.</p>
</footer>

</nav>

<main role="main" aria-label="Page app/javascript/controllers/template_form_handler.js">

<p>document.addEventListener(‘turbo:load’, () =&gt; {</p>

<pre>const formContainer = document.querySelector(&#39;.template-form-container&#39;);
if (!formContainer) return;

// Inicializa o índice global de questões para NOVOS campos.
// O valor inicial é o número de blocos existentes na página (para que novos IDs não se sobreponham).
let questionIndex = formContainer.querySelectorAll(&#39;.js-question-block&#39;).length; 
let optionCounters = {}; 

// --- Lógica de Remoção (Marca para exclusão ou remove do DOM) ---
const removeNestedItem = (event) =&gt; {
    event.preventDefault();
    // Item pode ser o bloco da Questão (.js-question-block) ou Opção (.js-option-item)
    const itemToRemove = event.target.closest(&#39;.js-question-block&#39;) || event.target.closest(&#39;.js-option-item&#39;);
    if (!itemToRemove) return;

    // O campo _destroy é necessário para dizer ao Rails para deletar no banco.
    const destroyField = itemToRemove.querySelector(&#39;input[name*=&quot;_destroy&quot;]&#39;);

    if (destroyField) {
        // Se tem _destroy (item existe no banco ou foi recém-criado na tela):
        destroyField.value = &#39;1&#39;; 
        itemToRemove.style.display = &#39;none&#39;; // Esconde visualmente (soft delete)
    } else {
        // Se não tem (item criado e deletado antes de salvar), apenas remove do DOM:
        itemToRemove.remove();
    }
};

// --- Lógica de Criação ---

const toggleOptionsVisibility = (typeSelect) =&gt; {
    const questionBlock = typeSelect.closest(&#39;.js-question-block&#39;);
    if (!questionBlock) return;

    const optionsContainer = questionBlock.querySelector(&#39;.js-options-container&#39;);
    const addOptionButton = questionBlock.querySelector(&#39;.js-add-option-button&#39;);

    if (typeSelect.value === &#39;Radio&#39;) {
        optionsContainer.classList.remove(&#39;hidden&#39;);
        addOptionButton.classList.remove(&#39;hidden&#39;);
    } else {
        optionsContainer.classList.add(&#39;hidden&#39;);
        addOptionButton.classList.add(&#39;hidden&#39;);
    }
};

// ADICIONAR NOVA OPÇÃO (CORRIGIDO: NOME DA ASSOCIAÇÃO)
const addOptionField = (event) =&gt; {
    event.preventDefault();

    const questionBlock = event.target.closest(&#39;.js-question-block&#39;);
    // Pega o índice único da questão pai
    const qIndex = questionBlock.dataset.qindex; 
    const optionList = questionBlock.querySelector(&#39;.js-options-list&#39;);

    // Garante que o contador comece do zero para novos índices
    if (optionCounters[qIndex] === undefined) {
         // Se for a primeira vez, conta as existentes para continuar
        optionCounters[qIndex] = questionBlock.querySelectorAll(&#39;.js-option-item&#39;).length;
    }

    const optionIndex = new Date().getTime(); // Usar timestamp para índice único (Rails)

    const newOption = document.createElement(&#39;div&#39;);
    newOption.classList.add(&#39;mt-2&#39;, &#39;js-option-item&#39;);

    newOption.innerHTML = `
        &lt;div class=&quot;flex items-center space-x-2 mt-2 js-option-item&quot;&gt;
            &lt;input type=&quot;hidden&quot; name=&quot;template[questao_templates_attributes][${qIndex}][opcao_templates_attributes][${optionIndex}][id]&quot; value=&quot;&quot;&gt;

            &lt;input type=&quot;hidden&quot; name=&quot;template[questao_templates_attributes][${qIndex}][opcao_templates_attributes][${optionIndex}][_destroy]&quot; value=&quot;false&quot; class=&quot;js-destroy-option-checkbox&quot;&gt;

            &lt;input type=&quot;hidden&quot; name=&quot;template[questao_templates_attributes][${qIndex}][opcao_templates_attributes][${optionIndex}][numero_opcao]&quot; value=&quot;${optionCounters[qIndex] + 1}&quot;&gt;

            &lt;input 
                name=&quot;template[questao_templates_attributes][${qIndex}][opcao_templates_attributes][${optionIndex}][texto_opcao]&quot;
                type=&quot;text&quot;
                placeholder=&quot;Opção&quot;
                class=&quot;mt-1 block w-full border-b border-gray-300 focus:border-purple-600 focus:outline-none py-1&quot;
            &gt;
            &lt;button type=&quot;button&quot; class=&quot;text-red-500 hover:text-red-700 text-sm js-remove-option-btn&quot;&gt;X&lt;/button&gt;
        &lt;/div&gt;
    `;
    optionList.appendChild(newOption);

    // Atribui listener ao novo botão de remoção
    newOption.querySelector(&#39;.js-remove-option-btn&#39;).addEventListener(&#39;click&#39;, removeNestedItem);
    optionCounters[qIndex]++; // Incrementa o contador de opções para a próxima
};

// ADICIONAR NOVA QUESTÃO (CORRIGIDO: INCLUSÃO DE CAMPOS OBRIGATÓRIOS)
const addNewQuestionBlock = (event) =&gt; {
    event.preventDefault();

    // Usa o índice global e incrementa
    const qIndex = new Date().getTime(); // Timestamp para índice único (importante para novos)
    optionCounters[qIndex] = 0; 

    const newQuestionHTML = `
        &lt;div class=&quot;mb-6 border-b border-gray-200 pb-4 js-question-block&quot; data-qindex=&quot;${qIndex}&quot;&gt;
            &lt;h2 class=&quot;text-xl font-bold text-gray-800 mb-4&quot;&gt;Nova Questão&lt;/h2&gt;

            &lt;input type=&quot;hidden&quot; name=&quot;template[questao_templates_attributes][${qIndex}][id]&quot; value=&quot;&quot;&gt;

            &lt;input type=&quot;hidden&quot; name=&quot;template[questao_templates_attributes][${qIndex}][_destroy]&quot; value=&quot;false&quot; class=&quot;js-destroy-question-checkbox&quot;&gt;

            &lt;div class=&quot;grid grid-cols-2 gap-4&quot;&gt;
                &lt;div&gt;
                    &lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Tipo:&lt;/label&gt;
                    &lt;select 
                        name=&quot;template[questao_templates_attributes][${qIndex}][tipo_resposta]&quot;
                        class=&quot;mt-1 block w-full border-b border-gray-300 focus:border-purple-600 focus:outline-none py-1 js-type-select&quot;&gt;
                        &lt;option value=&quot;Radio&quot;&gt;Multipla Escolha&lt;/option&gt;
                        &lt;option value=&quot;Texto&quot;&gt;Texto&lt;/option&gt;
                    &lt;/select&gt;
                &lt;/div&gt;

                &lt;div&gt;
                    &lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Texto:&lt;/label&gt;
                    &lt;input 
                        name=&quot;template[questao_templates_attributes][${qIndex}][texto_questao]&quot;
                        type=&quot;text&quot;
                        placeholder=&quot;Texto da Questão&quot;
                        class=&quot;mt-1 block w-full border-b border-gray-300 focus:border-purple-600 focus:outline-none py-1&quot;&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class=&quot;mt-4 js-options-container&quot;&gt;
                &lt;label class=&quot;block text-sm font-medium text-gray-700&quot;&gt;Opções:&lt;/label&gt;
                &lt;div class=&quot;js-options-list&quot;&gt;
                    &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class=&quot;mt-4 flex justify-center js-add-option-button&quot;&gt;
                &lt;button type=&quot;button&quot;
                    class=&quot;h-8 w-8 rounded-full bg-gray-300 text-gray-700 hover:bg-gray-400 flex items-center justify-center js-add-option&quot;&gt;
                    &lt;span class=&quot;text-xl font-light&quot;&gt;+&lt;/span&gt;
                &lt;/button&gt;
            &lt;/div&gt;

            &lt;div class=&quot;mt-2 text-right&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;text-red-500 hover:text-red-700 text-sm js-remove-question&quot;&gt;Remover Questão&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    `;

    const container = formContainer.querySelector(&#39;#questions-container&#39;);
    container.insertAdjacentHTML(&#39;beforeend&#39;, newQuestionHTML);

    questionIndex++; // Incrementa o índice global (embora qIndex seja timestamp, o count é útil)

    // Atacha listeners para o novo bloco
    attachListeners();
};

// --- Inicialização e Reaplicação de Listeners ---
const attachListeners = () =&gt; {
    // 1. Visibilidade de Opções
    formContainer.querySelectorAll(&#39;.js-type-select&#39;).forEach(select =&gt; {
        select.removeEventListener(&#39;change&#39;, (e) =&gt; toggleOptionsVisibility(e.target)); 
        select.addEventListener(&#39;change&#39;, (e) =&gt; toggleOptionsVisibility(e.target));
        toggleOptionsVisibility(select);
    });

    // 2. Adicionar Opção
    formContainer.querySelectorAll(&#39;.js-add-option&#39;).forEach(button =&gt; {
        button.removeEventListener(&#39;click&#39;, addOptionField); 
        button.addEventListener(&#39;click&#39;, addOptionField);
    });

    // 3. Remover Questão
    formContainer.querySelectorAll(&#39;.js-remove-question&#39;).forEach(button =&gt; {
        button.removeEventListener(&#39;click&#39;, removeNestedItem); 
        button.addEventListener(&#39;click&#39;, removeNestedItem);
    });

    // 4. Remover Opção (Botões X)
    formContainer.querySelectorAll(&#39;.js-remove-option-btn&#39;).forEach(button =&gt; {
        button.removeEventListener(&#39;click&#39;, removeNestedItem); 
        button.addEventListener(&#39;click&#39;, removeNestedItem);
    });

    // 5. Adicionar Questão (Botão Principal)
    const mainAddQuestionButton = formContainer.querySelector(&#39;.js-add-question&#39;);
    if (mainAddQuestionButton) {
        mainAddQuestionButton.removeEventListener(&#39;click&#39;, addNewQuestionBlock); 
        mainAddQuestionButton.addEventListener(&#39;click&#39;, addNewQuestionBlock);
    }

    // 6. INICIALIZAR data-qindex e optionCounters para campos existentes (ESSENCIAL PARA EDIÇÃO)
    formContainer.querySelectorAll(&#39;.js-question-block&#39;).forEach((block, index) =&gt; {
         if (!block.dataset.qindex) {
            // Para campos existentes, usamos o índice sequencial para o JS
            block.dataset.qindex = index; 

            // Inicializa o contador de opções com base no que já está na tela
            const existingOptionsCount = block.querySelectorAll(&#39;.js-option-item&#39;).length;
            optionCounters[index] = existingOptionsCount;
         }
    });
};

attachListeners();</pre>

<p>});</p>

</main>
</body>

